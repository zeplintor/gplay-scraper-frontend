<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PlayStore Analytics Pro - Rapport Premium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #fafbfc;
            color: #1f2937;
            min-height: 100vh;
            padding: 24px;
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header Style Airtable */
        header {
            background: white;
            padding: 24px 32px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-icon {
            font-size: 1.75rem;
        }

        .header-text h1 {
            font-size: 1.5rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 2px;
        }

        .subtitle {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 400;
        }

        .license-status {
            background: #ecfdf5;
            color: #059669;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
            border: 1px solid #d1fae5;
        }

        /* Search Box Minimaliste */
        .search-box {
            background: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }

        .search-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        input {
            flex: 1;
            padding: 10px 14px;
            font-size: 0.875rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        input:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        button {
            padding: 10px 20px;
            font-size: 0.875rem;
            font-weight: 600;
            background: #6366f1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-family: 'Inter', sans-serif;
        }
        button:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }

        .license-btn {
            background: #10b981;
        }
        .license-btn:hover {
            background: #059669;
        }

        .export-btn {
            background: #f59e0b;
        }
        .export-btn:hover {
            background: #d97706;
        }

        .loading {
            text-align: center;
            padding: 48px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #e5e7eb;
            border-top: 3px solid #6366f1;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: #111827;
            color: white;
            padding: 14px 20px;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 10000;
            animation: slideIn 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
        }
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .toast.success { background: #10b981; }
        .toast.error { background: #ef4444; }

        /* Cards Style Airtable */
        .card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
            border: 1px solid #e5e7eb;
        }

        .app-hero {
            display: flex;
            gap: 24px;
            align-items: flex-start;
            padding-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 24px;
        }

        .app-icon-large {
            width: 100px;
            height: 100px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }

        .app-info {
            flex: 1;
        }

        .app-title {
            font-size: 1.875rem;
            font-weight: 700;
            color: #111827;
            margin-bottom: 8px;
        }

        .app-developer {
            font-size: 1rem;
            color: #6b7280;
            margin-bottom: 12px;
        }

        .app-badges {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .badge {
            background: #6366f1;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.8125rem;
        }

        .badge.free {
            background: #10b981;
        }

        .badge.rating {
            background: #f59e0b;
        }

        .section-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #111827;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            font-size: 1.25rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .stat-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }

        .stat-card:hover {
            border-color: #6366f1;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.1);
        }

        .stat-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #6366f1;
        }

        /* Chart Container */
        .chart-container {
            background: #f9fafb;
            padding: 24px;
            border-radius: 6px;
            margin: 16px 0;
            border: 1px solid #e5e7eb;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            gap: 16px;
            height: 200px;
            margin-top: 24px;
        }

        .bar {
            flex: 1;
            background: #6366f1;
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.2s;
        }

        .bar:hover {
            background: #4f46e5;
            transform: translateY(-4px);
        }

        .bar-value {
            position: absolute;
            top: -28px;
            width: 100%;
            text-align: center;
            font-weight: 600;
            color: #111827;
            font-size: 0.875rem;
        }

        .bar-label {
            position: absolute;
            bottom: -28px;
            width: 100%;
            text-align: center;
            font-size: 0.875rem;
            color: #6b7280;
            font-weight: 500;
        }

        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 16px;
        }

        .info-item {
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            border-left: 3px solid #6366f1;
        }

        .info-label {
            font-size: 0.75rem;
            color: #6b7280;
            text-transform: uppercase;
            margin-bottom: 6px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
        }

        /* Keywords */
        .keywords-container {
            margin-top: 16px;
        }

        .keywords-title {
            font-weight: 600;
            color: #6366f1;
            font-size: 0.875rem;
            margin-bottom: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .keywords-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .keyword-tag {
            background: #6366f1;
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .keyword-tag:hover {
            background: #4f46e5;
            transform: translateY(-1px);
        }

        .keyword-tag.bigram {
            background: #8b5cf6;
        }

        .keyword-tag.competitive {
            background: #f59e0b;
        }

        /* Screenshots */
        .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 12px;
            margin-top: 16px;
        }

        .screenshot-img {
            width: 100%;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }

        .screenshot-img:hover {
            transform: scale(1.03);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .header-image {
            width: 100%;
            max-width: 600px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin: 12px 0;
        }

        /* Permissions */
        .permission-item {
            background: #fef3c7;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 3px solid #f59e0b;
        }

        .permission-category {
            font-weight: 600;
            color: #d97706;
            font-size: 0.875rem;
            margin-bottom: 8px;
            text-transform: uppercase;
        }

        .permission-list {
            list-style: none;
            margin: 8px 0 0 16px;
        }

        .permission-list li {
            color: #6b7280;
            font-size: 0.875rem;
            padding: 4px 0;
            position: relative;
            padding-left: 20px;
        }

        .permission-list li::before {
            content: '•';
            position: absolute;
            left: 0;
            color: #f59e0b;
            font-weight: 700;
        }

        /* Reviews */
        .review-card {
            background: #f9fafb;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #e5e7eb;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .review-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .review-user {
            font-weight: 600;
            color: #111827;
            font-size: 0.875rem;
        }

        .review-stars {
            color: #f59e0b;
            font-size: 0.875rem;
        }

        .review-text {
            color: #6b7280;
            font-size: 0.875rem;
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .review-meta {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        /* Premium Lock */
        .section.premium {
            position: relative;
        }

        .section.premium .card-content {
            filter: blur(4px);
            pointer-events: none;
            user-select: none;
        }

        .unlock-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
            background: white;
            padding: 32px 48px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border: 1px solid #e5e7eb;
        }

        .unlock-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .unlock-text {
            font-size: 1.125rem;
            font-weight: 600;
            color: #6366f1;
            margin-bottom: 8px;
        }

        .unlock-price {
            font-size: 2rem;
            font-weight: 700;
            color: #6366f1;
        }

        /* CTA Final */
        .cta-final {
            text-align: center;
            padding: 48px 32px;
            background: #6366f1;
            border-radius: 8px;
            color: white;
            margin-top: 24px;
        }

        .cta-final h2 {
            font-size: 2rem;
            margin-bottom: 16px;
            font-weight: 700;
        }

        .cta-price {
            background: white;
            color: #6366f1;
            padding: 16px 32px;
            border-radius: 6px;
            display: inline-block;
            font-size: 2rem;
            font-weight: 700;
            margin: 16px 0;
        }

        .features-premium {
            list-style: none;
            text-align: left;
            max-width: 600px;
            margin: 24px auto;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
        }

        .features-premium li {
            padding: 10px 12px 10px 32px;
            position: relative;
            font-size: 0.9375rem;
            font-weight: 500;
            background: rgba(255,255,255,0.1);
            border-radius: 6px;
        }

        .features-premium li::before {
            content: '✓';
            position: absolute;
            left: 10px;
            font-weight: 700;
            font-size: 1.25rem;
        }

        .cta-buttons {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 24px;
        }

        .cta-btn-primary {
            background: white;
            color: #6366f1;
            font-size: 1rem;
            padding: 14px 32px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .cta-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .guarantee {
            margin-top: 24px;
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Export Menu */
        .export-container {
            position: relative;
            display: inline-block;
        }

        .export-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: white;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 1000;
            overflow: hidden;
            border: 1px solid #e5e7eb;
        }

        .export-menu.active {
            display: block;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .export-menu-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            border-bottom: 1px solid #f3f4f6;
            color: #374151;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .export-menu-item:last-child {
            border-bottom: none;
        }

        .export-menu-item:hover {
            background: #f9fafb;
            padding-left: 20px;
        }

        .export-menu-item .icon {
            font-size: 1.125rem;
        }

        .export-menu-item .label {
            flex: 1;
        }

        .export-menu-item .format {
            font-size: 0.6875rem;
            color: #9ca3af;
            text-transform: uppercase;
            font-weight: 600;
        }

        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 5rem;
            font-weight: 900;
            color: rgba(239, 68, 68, 0.06);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-left">
                <span class="header-icon">💎</span>
                <div class="header-text">
                    <h1>PlayStore Analytics Pro</h1>
                    <p class="subtitle">Rapport Premium Ultra-Détaillé</p>
                </div>
            </div>
            <div id="licenseStatus"></div>
        </header>

        <div class="search-box">
            <div class="search-container">
                <input type="text" id="appId" placeholder="Entrez l'ID de l'application (ex: com.roblox.client)" value="com.roblox.client">
                <button id="searchBtn">Analyser</button>
                <button id="licenseBtn" class="license-btn">Licence</button>
                <div class="export-container">
                    <button id="exportBtn" class="export-btn">Exporter</button>
                    <div id="exportMenu" class="export-menu">
                        <div class="export-menu-item" data-format="pdf">
                            <span class="icon">📄</span>
                            <span class="label">Export PDF</span>
                            <span class="format">PDF</span>
                        </div>
                        <div class="export-menu-item" data-format="json">
                            <span class="icon">📊</span>
                            <span class="label">Export JSON</span>
                            <span class="format">JSON</span>
                        </div>
                        <div class="export-menu-item" data-format="csv">
                            <span class="icon">📋</span>
                            <span class="label">Export CSV</span>
                            <span class="format">CSV</span>
                        </div>
                        <div class="export-menu-item" data-format="png">
                            <span class="icon">🖼️</span>
                            <span class="label">Export PNG</span>
                            <span class="format">PNG</span>
                        </div>
                        <div class="export-menu-item" data-format="html">
                            <span class="icon">🌐</span>
                            <span class="label">Export HTML</span>
                            <span class="format">HTML</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display:none;">
            <div class="spinner"></div>
            <p style="font-size:0.9375rem; font-weight:600; color:#6366f1; margin-top:12px;">Analyse en cours...</p>
        </div>

        <div id="reportContainer"></div>
    </div>

<script>
const API = 'https://gplay-scraper-backend.onrender.com';
let fullData = null;
let hasLicense = false;

function fmt(n) {
    if (!n) return '0';
    if (n >= 1e9) return (n/1e9).toFixed(1) + 'B';
    if (n >= 1e6) return (n/1e6).toFixed(1) + 'M';
    if (n >= 1e3) return (n/1e3).toFixed(1) + 'K';
    return n.toString();
}

function toast(msg, type) {
    const t = document.createElement('div');
    t.className = 'toast ' + type;
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(() => t.remove(), 3500);
}

function checkLicense() {
    const license = localStorage.getItem('license');
    if (license && (license === 'PREMIUM-2025' || license === 'TEST-LICENSE' || license.startsWith('GR-'))) {
        hasLicense = true;
        document.getElementById('licenseStatus').innerHTML =
            '<span class="license-status">✓ Premium Actif</span>';
    }
}

document.getElementById('licenseBtn').onclick = function() {
    const key = prompt('Entrez votre clé de licence :\n\nClés de test : PREMIUM-2025, TEST-LICENSE');
    if (!key) return;

    if (key === 'PREMIUM-2025' || key === 'TEST-LICENSE' || key.startsWith('GR-')) {
        localStorage.setItem('license', key);
        hasLicense = true;
        toast('Licence activée avec succès', 'success');
        checkLicense();
        if (fullData) generateReport(fullData);
    } else {
        toast('Clé de licence invalide', 'error');
    }
};

document.getElementById('searchBtn').onclick = async function() {
    const id = document.getElementById('appId').value.trim();
    if (!id) return toast('Veuillez entrer un ID d\'application', 'error');

    document.getElementById('loading').style.display = 'block';
    document.getElementById('reportContainer').innerHTML = '';

    try {
        const res = await fetch(`${API}/api/analyze/${id}`);
        const data = await res.json();

        if (data.success) {
            fullData = data.data;
            generateReport(data.data);
            toast('Analyse terminée', 'success');
        } else {
            toast('Application non trouvée', 'error');
        }
    } catch (e) {
        toast('Erreur: ' + e.message, 'error');
    }

    document.getElementById('loading').style.display = 'none';
};

function generateReport(data) {
    const container = document.getElementById('reportContainer');
    const histogram = data.histogram || [0,0,0,0,0];
    const maxHist = Math.max(...histogram);

    let html = '';

    // Hero Card
    html += `
        <div class="card">
            <div class="app-hero">
                <img class="app-icon-large" src="${data.icon || ''}" alt="App Icon">
                <div class="app-info">
                    <h1 class="app-title">${data.title || 'N/A'}</h1>
                    <p class="app-developer">${data.developer || 'N/A'}</p>
                    <div class="app-badges">
                        <span class="badge">${data.genre || 'N/A'}</span>
                        <span class="badge free">${data.free ? 'Gratuit' : '$' + (data.price || 'N/A')}</span>
                        ${data.score ? `<span class="badge rating">${data.score.toFixed(1)} ⭐</span>` : ''}
                        ${data.contentRating ? `<span class="badge">${data.contentRating}</span>` : ''}
                    </div>
                </div>
            </div>
        </div>
    `;

    // Section 1: Statistiques Principales
    html += `
        <div class="card">
            <div class="section-title">
                <span class="section-icon">📊</span>
                Statistiques Principales
            </div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Note Moyenne</div>
                    <div class="stat-value">${data.score ? data.score.toFixed(1) : 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nombre d'Avis</div>
                    <div class="stat-value">${fmt(data.ratings || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Installations</div>
                    <div class="stat-value">${data.installs || 'N/A'}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Reviews Totales</div>
                    <div class="stat-value">${fmt(data.reviews || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Installs Réelles</div>
                    <div class="stat-value">${fmt(data.realInstalls || 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Installs/Jour</div>
                    <div class="stat-value">${fmt(data.dailyInstalls || 0)}</div>
                </div>
            </div>
        </div>
    `;

    // Section 2: Distribution des Notes
    html += `
        <div class="card">
            <div class="section-title">
                <span class="section-icon">⭐</span>
                Distribution des Notes
            </div>
            <div class="chart-container">
                <div class="bar-chart">
    `;
    for (let i = 0; i < 5; i++) {
        const height = maxHist > 0 ? (histogram[i] / maxHist) * 100 : 0;
        html += `
            <div class="bar" style="height:${height}%">
                <div class="bar-value">${fmt(histogram[i])}</div>
                <div class="bar-label">${i + 1} ★</div>
            </div>
        `;
    }
    html += `
                </div>
            </div>
        </div>
    `;

    // Section 3: Informations Temporelles
    html += `
        <div class="card">
            <div class="section-title">
                <span class="section-icon">📅</span>
                Informations Temporelles
            </div>
            <div class="info-grid">
                <div class="info-item">
                    <div class="info-label">Date de Sortie</div>
                    <div class="info-value">${data.released || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Dernière MAJ</div>
                    <div class="info-value">${data.lastUpdated || 'N/A'}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Âge (jours)</div>
                    <div class="info-value">${data.appAgeDays || 0}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Version</div>
                    <div class="info-value">${data.version || 'N/A'}</div>
                </div>
            </div>
        </div>
    `;

    // Section 4: Informations Techniques (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">🔧</span>
                    Informations Techniques
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Android Min</div>
                        <div class="info-value">API ${data.minAndroidApi || '?'}+</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Android Max</div>
                        <div class="info-value">API ${data.maxAndroidApi || '?'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">App Bundle</div>
                        <div class="info-value">${data.appBundle ? '✓ Oui' : '✗ Non'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Publicités</div>
                        <div class="info-value">${data.adSupported ? '✓ Oui' : '✗ Non'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Achats Intégrés</div>
                        <div class="info-value">${data.offersIAP ? '✓ Oui' : '✗ Non'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Prix IAP</div>
                        <div class="info-value">${data.inAppProductPrice || 'N/A'}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Section 5: Informations Développeur (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">👨‍💻</span>
                    Informations Développeur
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Developer ID</div>
                        <div class="info-value" style="font-size:0.8125rem;">${data.developerId || 'N/A'}</div>
                    </div>
                    <div class="info-item" style="grid-column:span 2;">
                        <div class="info-label">Email</div>
                        <div class="info-value" style="font-size:0.875rem;">${data.developerEmail || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Website</div>
                        <div class="info-value">${data.developerWebsite ? '✓ Disponible' : 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Privacy Policy</div>
                        <div class="info-value">${data.privacyPolicy ? '✓ Oui' : '✗ Non'}</div>
                    </div>
                </div>
            </div>
        </div>
    `;

    // Section 6: SEO & ASO (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">🔍</span>
                    Analyse SEO & ASO
                </div>
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">Mots-Clés Uniques</div>
                        <div class="info-value">${data.uniqueKeywords || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Total Mots</div>
                        <div class="info-value">${data.totalWords || 0}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Score Lisibilité</div>
                        <div class="info-value">${data.readability?.flesch_score?.toFixed(1) || 'N/A'}</div>
                    </div>
                </div>
    `;

    if (data.topKeywords && Object.keys(data.topKeywords).length > 0) {
        html += `
            <div class="keywords-container">
                <div class="keywords-title">Top Keywords</div>
                <div class="keywords-grid">
        `;
        const topK = Object.entries(data.topKeywords).slice(0, 10);
        topK.forEach(([key, val]) => {
            html += `<span class="keyword-tag">${key} (${val})</span>`;
        });
        html += `</div></div>`;
    }

    if (data.topBigrams && Object.keys(data.topBigrams).length > 0) {
        html += `
            <div class="keywords-container">
                <div class="keywords-title" style="color:#8b5cf6;">Top Bigrams</div>
                <div class="keywords-grid">
        `;
        const topB = Object.entries(data.topBigrams).slice(0, 8);
        topB.forEach(([key, val]) => {
            html += `<span class="keyword-tag bigram">${key} (${val})</span>`;
        });
        html += `</div></div>`;
    }

    html += `</div></div>`;

    // Section 7: Médias (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">🖼️</span>
                    Médias & Visuels
                </div>
    `;

    if (data.screenshots && data.screenshots.length > 0) {
        html += `
            <div>
                <div style="font-weight:600;font-size:0.875rem;color:#6b7280;margin-bottom:12px;">Screenshots (${data.screenshots.length})</div>
                <div class="screenshots-grid">
        `;
        data.screenshots.slice(0, 6).forEach(url => {
            html += `<img src="${url}" class="screenshot-img" alt="Screenshot">`;
        });
        html += `</div></div>`;
    }

    if (data.headerImage) {
        html += `
            <div style="margin-top:24px;">
                <div style="font-weight:600;font-size:0.875rem;color:#6b7280;margin-bottom:12px;">Header Image</div>
                <img src="${data.headerImage}" class="header-image" alt="Header">
            </div>
        `;
    }

    html += `</div></div>`;

    // Section 8: Permissions (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">🔐</span>
                    Permissions & Sécurité
                </div>
    `;

    if (data.permissions && Object.keys(data.permissions).length > 0) {
        html += `<div>`;
        for (let perm in data.permissions) {
            html += `
                <div class="permission-item">
                    <div class="permission-category">${perm}</div>
                    <ul class="permission-list">
            `;
            data.permissions[perm].forEach(p => {
                html += `<li>${p}</li>`;
            });
            html += `</ul></div>`;
        }
        html += `</div>`;
    }

    html += `</div></div>`;

    // Section 9: Reviews (PREMIUM)
    html += `
        <div class="card section ${!hasLicense ? 'premium' : ''}">
            ${!hasLicense ? '<div class="unlock-overlay"><div class="unlock-icon">🔒</div><div class="unlock-text">Section Premium</div><div class="unlock-price">9,99€</div></div>' : ''}
            <div class="card-content">
                <div class="section-title">
                    <span class="section-icon">💬</span>
                    Reviews Récentes
                </div>
    `;

    if (data.reviewsData && data.reviewsData.length > 0) {
        data.reviewsData.slice(0, 3).forEach(review => {
            html += `
                <div class="review-card">
                    <div class="review-header">
                        ${review.avatar ? `<img src="${review.avatar}" class="review-avatar" alt="Avatar">` : ''}
                        <div>
                            <div class="review-user">${review.user || 'Utilisateur'}</div>
                            <div class="review-stars">${'⭐'.repeat(review.rating || 0)}</div>
                        </div>
                    </div>
                    <p class="review-text">${review.text || ''}</p>
                    ${review.version ? `<div class="review-meta">Version: ${review.version}</div>` : ''}
                </div>
            `;
        });
    } else {
        html += `<p style="text-align:center;color:#9ca3af;font-size:0.875rem;">Aucune review disponible</p>`;
    }

    html += `</div></div>`;

    // CTA Final
    if (!hasLicense) {
        html += `
            <div class="cta-final">
                <h2>Débloquez TOUTES les Données Premium</h2>
                <div class="cta-price">9,99€</div>
                <p style="font-size:1.125rem;margin:16px 0;font-weight:500;">
                    65+ Métriques • Screenshots • Reviews • Keywords • Permissions
                </p>
                <ul class="features-premium">
                    <li>Statistiques détaillées</li>
                    <li>Analyse ASO complète</li>
                    <li>Keywords & bigrams</li>
                    <li>Screenshots complets</li>
                    <li>Reviews avec avatars</li>
                    <li>Permissions détaillées</li>
                    <li>Export PDF professionnel</li>
                    <li>Support prioritaire</li>
                </ul>
                <div class="cta-buttons">
                    <a href="https://votresite.gumroad.com/l/playstore-pro" target="_blank">
                        <button class="cta-btn-primary">Acheter sur Gumroad</button>
                    </a>
                </div>
                <p class="guarantee">
                    ✓ Paiement sécurisé • Accès instantané • Garantie 30 jours
                </p>
            </div>
        `;
    }

    container.innerHTML = html;
}

// ============ EXPORT FUNCTIONS ============

// Toggle Export Menu
document.getElementById('exportBtn').onclick = function(e) {
    e.stopPropagation();
    const menu = document.getElementById('exportMenu');
    menu.classList.toggle('active');
};

document.addEventListener('click', function(e) {
    const menu = document.getElementById('exportMenu');
    const exportContainer = document.querySelector('.export-container');
    if (!exportContainer.contains(e.target)) {
        menu.classList.remove('active');
    }
});

document.querySelectorAll('.export-menu-item').forEach(item => {
    item.addEventListener('click', function() {
        const format = this.dataset.format;
        document.getElementById('exportMenu').classList.remove('active');

        if (!fullData) {
            toast('Veuillez d\'abord analyser une application', 'error');
            return;
        }

        handleExport(format);
    });
});

async function handleExport(format) {
    toast('Génération en cours...', 'success');

    try {
        switch(format) {
            case 'json':
                exportJSON();
                break;
            case 'csv':
                exportCSV();
                break;
            case 'pdf':
                await exportPDF();
                break;
            case 'png':
                await exportPNG();
                break;
            case 'html':
                exportHTML();
                break;
        }
        setTimeout(() => toast('Export réussi', 'success'), 500);
    } catch(e) {
        toast('Erreur lors de l\'export: ' + e.message, 'error');
        console.error('Export error:', e);
    }
}

function exportJSON() {
    const exportData = {
        metadata: {
            exportDate: new Date().toISOString(),
            appId: document.getElementById('appId').value,
            hasLicense: hasLicense,
            version: '1.0'
        },
        data: fullData
    };

    const dataStr = JSON.stringify(exportData, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    downloadFile(blob, `${fullData.title || 'app'}_data.json`);
}

function exportCSV() {
    const data = fullData;
    let csv = 'Métrique,Valeur,Catégorie\n';

    csv += `Note moyenne,${data.score || 'N/A'},Statistiques\n`;
    csv += `Nombre d'avis,${data.ratings || 0},Statistiques\n`;
    csv += `Installations,${data.installs || 'N/A'},Statistiques\n`;
    csv += `Reviews totales,${data.reviews || 0},Statistiques\n`;
    csv += `Installations réelles,${data.realInstalls || 0},Statistiques\n`;
    csv += `Installations/jour,${data.dailyInstalls || 0},Statistiques\n`;
    csv += `Date de sortie,${data.released || 'N/A'},Temporel\n`;
    csv += `Dernière MAJ,${data.lastUpdated || 'N/A'},Temporel\n`;
    csv += `Âge (jours),${data.appAgeDays || 0},Temporel\n`;
    csv += `Version actuelle,${data.version || 'N/A'},Temporel\n`;

    if (hasLicense) {
        csv += `Android minimum,API ${data.minAndroidApi || '?'},Technique\n`;
        csv += `Publicités,${data.adSupported ? 'Oui' : 'Non'},Technique\n`;
        csv += `Achats intégrés,${data.offersIAP ? 'Oui' : 'Non'},Technique\n`;
        csv += `Mots-clés uniques,${data.uniqueKeywords || 0},SEO\n`;
        csv += `Total mots,${data.totalWords || 0},SEO\n`;
    }

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    downloadFile(blob, `${data.title || 'app'}_stats.csv`);
}

// EXPORT PDF AMÉLIORÉ ET COMPLET
async function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');

    const data = fullData;
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();
    const margin = 15;
    let yPos = 20;

    // PAGE DE GARDE
    doc.setFillColor(99, 102, 241);
    doc.rect(0, 0, pageWidth, 60, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(32);
    doc.setFont(undefined, 'bold');
    doc.text('PlayStore Analytics Pro', pageWidth/2, 30, { align: 'center' });
    doc.setFontSize(14);
    doc.setFont(undefined, 'normal');
    doc.text('Rapport Premium Détaillé', pageWidth/2, 45, { align: 'center' });

    // Watermark pour version gratuite
    if (!hasLicense) {
        doc.setTextColor(239, 68, 68);
        doc.setFontSize(50);
        doc.setFont(undefined, 'bold');
        doc.saveGraphicsState();
        doc.setGState(new doc.GState({ opacity: 0.08 }));
        doc.text('VERSION GRATUITE', pageWidth/2, pageHeight/2, {
            align: 'center',
            angle: 45
        });
        doc.restoreGraphicsState();
    }

    yPos = 75;
    doc.setTextColor(0, 0, 0);

    // Info App
    doc.setFontSize(22);
    doc.setFont(undefined, 'bold');
    doc.text(data.title || 'N/A', margin, yPos);
    yPos += 10;
    doc.setFontSize(12);
    doc.setFont(undefined, 'normal');
    doc.text(`Développeur: ${data.developer || 'N/A'}`, margin, yPos);
    yPos += 7;
    doc.text(`Genre: ${data.genre || 'N/A'}`, margin, yPos);
    yPos += 7;
    doc.text(`Date d'export: ${new Date().toLocaleDateString('fr-FR')}`, margin, yPos);
    yPos += 15;

    // TABLE DES MATIÈRES
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(99, 102, 241);
    doc.text('Table des Matières', margin, yPos);
    yPos += 10;
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    doc.setTextColor(0, 0, 0);

    const toc = [
        '1. Statistiques Principales',
        '2. Distribution des Notes',
        '3. Informations Temporelles',
        '4. Informations Techniques (Premium)',
        '5. Informations Développeur (Premium)',
        '6. Analyse SEO & ASO (Premium)',
        '7. Médias & Visuels (Premium)',
        '8. Permissions & Sécurité (Premium)',
        '9. Reviews Récentes (Premium)'
    ];

    toc.forEach(item => {
        if (yPos > pageHeight - 20) {
            doc.addPage();
            yPos = 20;
        }
        doc.text(item, margin + 5, yPos);
        yPos += 6;
    });

    // NOUVELLE PAGE - STATISTIQUES PRINCIPALES
    doc.addPage();
    yPos = 20;

    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(99, 102, 241);
    doc.text('1. Statistiques Principales', margin, yPos);
    yPos += 12;

    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    // Stats en colonnes (2 colonnes)
    const stats = [
        ['Note moyenne', `${data.score?.toFixed(1) || 'N/A'} ⭐`],
        ['Nombre d\'avis', fmt(data.ratings || 0)],
        ['Installations', data.installs || 'N/A'],
        ['Reviews totales', fmt(data.reviews || 0)],
        ['Installations réelles', fmt(data.realInstalls || 0)],
        ['Installations/jour', fmt(data.dailyInstalls || 0)],
        ['Installations/mois', fmt(data.monthlyInstalls || 0)],
        ['Installations min', fmt(data.minInstalls || 0)]
    ];

    const colWidth = (pageWidth - 2 * margin) / 2;
    let col = 0;
    let baseY = yPos;

    stats.forEach(([label, value], idx) => {
        if (idx > 0 && idx % 4 === 0) {
            col = 1;
            yPos = baseY;
        }

        const xPos = margin + (col * colWidth);

        // Box pour chaque stat
        doc.setFillColor(249, 250, 251);
        doc.roundedRect(xPos, yPos - 5, colWidth - 5, 12, 2, 2, 'F');
        doc.setDrawColor(229, 231, 235);
        doc.roundedRect(xPos, yPos - 5, colWidth - 5, 12, 2, 2, 'S');

        doc.setFont(undefined, 'bold');
        doc.setFontSize(8);
        doc.setTextColor(107, 114, 128);
        doc.text(label.toUpperCase(), xPos + 3, yPos);

        doc.setFont(undefined, 'bold');
        doc.setFontSize(11);
        doc.setTextColor(99, 102, 241);
        doc.text(String(value), xPos + 3, yPos + 5);

        yPos += 14;
    });

    yPos = baseY + (4 * 14) + 10;

    // DISTRIBUTION DES NOTES (GRAPHIQUE)
    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(99, 102, 241);
    doc.text('2. Distribution des Notes', margin, yPos);
    yPos += 12;

    const histogram = data.histogram || [0,0,0,0,0];
    const maxHist = Math.max(...histogram);
    const chartWidth = pageWidth - 2 * margin;
    const chartHeight = 50;
    const barWidth = chartWidth / 5 - 4;

    for (let i = 0; i < 5; i++) {
        const barHeight = maxHist > 0 ? (histogram[i] / maxHist) * chartHeight : 0;
        const xBar = margin + (i * (barWidth + 4));
        const yBar = yPos + chartHeight - barHeight;

        // Dessiner barre
        doc.setFillColor(99, 102, 241);
        doc.roundedRect(xBar, yBar, barWidth, barHeight, 2, 2, 'F');

        // Valeur au-dessus
        doc.setFontSize(9);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(0, 0, 0);
        doc.text(fmt(histogram[i]), xBar + barWidth/2, yBar - 3, { align: 'center' });

        // Label en-dessous
        doc.setFontSize(8);
        doc.setTextColor(107, 114, 128);
        doc.text(`${i + 1} ★`, xBar + barWidth/2, yPos + chartHeight + 5, { align: 'center' });
    }

    yPos += chartHeight + 15;

    // INFORMATIONS TEMPORELLES
    if (yPos > pageHeight - 60) {
        doc.addPage();
        yPos = 20;
    }

    doc.setFontSize(16);
    doc.setFont(undefined, 'bold');
    doc.setTextColor(99, 102, 241);
    doc.text('3. Informations Temporelles', margin, yPos);
    yPos += 12;
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');

    const temporal = [
        ['Date de sortie', data.released || 'N/A'],
        ['Dernière MAJ', data.lastUpdated || 'N/A'],
        ['Âge de l\'app', `${data.appAgeDays || 0} jours`],
        ['Version actuelle', data.version || 'N/A']
    ];

    temporal.forEach(([label, value]) => {
        doc.setFillColor(249, 250, 251);
        doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'F');
        doc.setDrawColor(229, 231, 235);
        doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'S');

        doc.setFont(undefined, 'bold');
        doc.setFontSize(9);
        doc.setTextColor(107, 114, 128);
        doc.text(label, margin + 3, yPos);

        doc.setFont(undefined, 'normal');
        doc.setTextColor(17, 24, 39);
        doc.text(value, margin + 60, yPos);

        yPos += 12;
    });

    // SECTIONS PREMIUM (si licence active)
    if (hasLicense) {
        // INFORMATIONS TECHNIQUES
        doc.addPage();
        yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(99, 102, 241);
        doc.text('4. Informations Techniques', margin, yPos);
        yPos += 12;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');

        const technical = [
            ['Android minimum', `API ${data.minAndroidApi || '?'}+`],
            ['Android maximum', `API ${data.maxAndroidApi || '?'}`],
            ['Version Android', data.androidVersion || 'N/A'],
            ['App Bundle', data.appBundle ? 'Oui' : 'Non'],
            ['Publicités', data.adSupported ? 'Oui' : 'Non'],
            ['Contient des Ads', data.containsAds ? 'Oui' : 'Non'],
            ['Achats intégrés', data.offersIAP ? 'Oui' : 'Non'],
            ['Prix IAP', data.inAppProductPrice || 'N/A']
        ];

        technical.forEach(([label, value]) => {
            if (yPos > pageHeight - 20) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFillColor(249, 250, 251);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'S');

            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.setTextColor(107, 114, 128);
            doc.text(label, margin + 3, yPos);

            doc.setFont(undefined, 'normal');
            doc.setTextColor(17, 24, 39);
            doc.text(String(value), margin + 60, yPos);

            yPos += 12;
        });

        // DÉVELOPPEUR
        yPos += 8;
        if (yPos > pageHeight - 60) {
            doc.addPage();
            yPos = 20;
        }

        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(99, 102, 241);
        doc.text('5. Informations Développeur', margin, yPos);
        yPos += 12;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');

        const devInfo = [
            ['Developer ID', data.developerId || 'N/A'],
            ['Email', data.developerEmail || 'N/A'],
            ['Website', data.developerWebsite ? 'Disponible' : 'N/A'],
            ['Privacy Policy', data.privacyPolicy ? 'Oui' : 'Non']
        ];

        devInfo.forEach(([label, value]) => {
            if (yPos > pageHeight - 20) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFillColor(249, 250, 251);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'S');

            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.setTextColor(107, 114, 128);
            doc.text(label, margin + 3, yPos);

            doc.setFont(undefined, 'normal');
            doc.setTextColor(17, 24, 39);
            doc.setFontSize(8);
            const maxWidth = pageWidth - margin - 70;
            const splitValue = doc.splitTextToSize(String(value), maxWidth);
            doc.text(splitValue, margin + 60, yPos);

            yPos += 12;
        });

        // SEO & ASO
        doc.addPage();
        yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(99, 102, 241);
        doc.text('6. Analyse SEO & ASO', margin, yPos);
        yPos += 12;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');

        const seoInfo = [
            ['Mots-clés uniques', String(data.uniqueKeywords || 0)],
            ['Total mots', String(data.totalWords || 0)],
            ['Score lisibilité', data.readability?.flesch_score?.toFixed(1) || 'N/A'],
            ['Niveau lecture', data.readability?.flesch_level || 'N/A']
        ];

        seoInfo.forEach(([label, value]) => {
            doc.setFillColor(249, 250, 251);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'F');
            doc.setDrawColor(229, 231, 235);
            doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, 10, 2, 2, 'S');

            doc.setFont(undefined, 'bold');
            doc.setFontSize(9);
            doc.setTextColor(107, 114, 128);
            doc.text(label, margin + 3, yPos);

            doc.setFont(undefined, 'normal');
            doc.setTextColor(17, 24, 39);
            doc.text(value, margin + 60, yPos);

            yPos += 12;
        });

        // TOP KEYWORDS
        if (data.topKeywords && Object.keys(data.topKeywords).length > 0) {
            yPos += 8;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(99, 102, 241);
            doc.text('Top Keywords', margin, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);

            const topK = Object.entries(data.topKeywords).slice(0, 15);
            let xKeyword = margin;
            let keywordLine = yPos;

            topK.forEach(([key, val], idx) => {
                const text = `${key} (${val})`;
                const textWidth = doc.getTextWidth(text) + 8;

                if (xKeyword + textWidth > pageWidth - margin) {
                    xKeyword = margin;
                    keywordLine += 8;
                }

                if (keywordLine > pageHeight - 20) {
                    doc.addPage();
                    keywordLine = 20;
                    xKeyword = margin;
                }

                doc.setFillColor(99, 102, 241);
                doc.roundedRect(xKeyword, keywordLine - 5, textWidth, 6, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(text, xKeyword + 4, keywordLine);

                xKeyword += textWidth + 3;
            });

            yPos = keywordLine + 8;
        }

        // TOP BIGRAMS
        if (data.topBigrams && Object.keys(data.topBigrams).length > 0) {
            yPos += 8;
            if (yPos > pageHeight - 40) {
                doc.addPage();
                yPos = 20;
            }

            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(139, 92, 246);
            doc.text('Top Bigrams', margin, yPos);
            yPos += 8;

            doc.setFontSize(9);
            doc.setFont(undefined, 'normal');

            const topB = Object.entries(data.topBigrams).slice(0, 10);
            let xBigram = margin;
            let bigramLine = yPos;

            topB.forEach(([key, val]) => {
                const text = `${key} (${val})`;
                const textWidth = doc.getTextWidth(text) + 8;

                if (xBigram + textWidth > pageWidth - margin) {
                    xBigram = margin;
                    bigramLine += 8;
                }

                if (bigramLine > pageHeight - 20) {
                    doc.addPage();
                    bigramLine = 20;
                    xBigram = margin;
                }

                doc.setFillColor(139, 92, 246);
                doc.roundedRect(xBigram, bigramLine - 5, textWidth, 6, 1, 1, 'F');
                doc.setTextColor(255, 255, 255);
                doc.text(text, xBigram + 4, bigramLine);

                xBigram += textWidth + 3;
            });

            yPos = bigramLine + 8;
        }

        // MÉDIAS
        doc.addPage();
        yPos = 20;

        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.setTextColor(99, 102, 241);
        doc.text('7. Médias & Visuels', margin, yPos);
        yPos += 12;
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');

        doc.text(`Screenshots: ${data.screenshots?.length || 0}`, margin, yPos);
        yPos += 7;
        doc.text(`Header Image: ${data.headerImage ? 'Disponible' : 'Non disponible'}`, margin, yPos);
        yPos += 7;
        doc.text(`Vidéo: ${data.video ? 'Disponible' : 'Non disponible'}`, margin, yPos);

        // PERMISSIONS
        if (data.permissions && Object.keys(data.permissions).length > 0) {
            doc.addPage();
            yPos = 20;

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(99, 102, 241);
            doc.text('8. Permissions & Sécurité', margin, yPos);
            yPos += 12;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);

            for (let perm in data.permissions) {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFont(undefined, 'bold');
                doc.setTextColor(245, 158, 11);
                doc.text(perm, margin, yPos);
                yPos += 7;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);

                data.permissions[perm].forEach(p => {
                    if (yPos > pageHeight - 15) {
                        doc.addPage();
                        yPos = 20;
                    }
                    doc.text(`• ${p}`, margin + 5, yPos);
                    yPos += 5;
                });

                yPos += 5;
                doc.setFontSize(10);
            }
        }

        // REVIEWS
        if (data.reviewsData && data.reviewsData.length > 0) {
            doc.addPage();
            yPos = 20;

            doc.setFontSize(16);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(99, 102, 241);
            doc.text('9. Reviews Récentes', margin, yPos);
            yPos += 12;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.setTextColor(0, 0, 0);

            data.reviewsData.slice(0, 5).forEach(review => {
                if (yPos > pageHeight - 40) {
                    doc.addPage();
                    yPos = 20;
                }

                doc.setFillColor(249, 250, 251);
                const boxHeight = 25;
                doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, boxHeight, 2, 2, 'F');
                doc.setDrawColor(229, 231, 235);
                doc.roundedRect(margin, yPos - 5, pageWidth - 2 * margin, boxHeight, 2, 2, 'S');

                doc.setFont(undefined, 'bold');
                doc.setFontSize(10);
                doc.setTextColor(17, 24, 39);
                doc.text(review.user || 'Utilisateur', margin + 3, yPos);

                doc.setTextColor(245, 158, 11);
                doc.text('⭐'.repeat(review.rating || 0), pageWidth - margin - 20, yPos);

                yPos += 6;
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(107, 114, 128);
                const reviewText = doc.splitTextToSize(review.text || '', pageWidth - 2 * margin - 6);
                doc.text(reviewText.slice(0, 2), margin + 3, yPos);

                yPos += boxHeight;
            });
        }
    } else {
        // Message premium
        doc.addPage();
        yPos = 80;
        doc.setFontSize(18);
        doc.setTextColor(99, 102, 241);
        doc.setFont(undefined, 'bold');
        doc.text('Sections Premium', pageWidth/2, yPos, { align: 'center' });
        yPos += 15;
        doc.setFontSize(12);
        doc.setFont(undefined, 'normal');
        doc.setTextColor(107, 114, 128);
        doc.text('Débloquez toutes les données premium pour 9,99€', pageWidth/2, yPos, { align: 'center' });
        yPos += 10;
        doc.text('Informations Techniques • Développeur • SEO & ASO', pageWidth/2, yPos, { align: 'center' });
        yPos += 6;
        doc.text('Médias • Permissions • Reviews', pageWidth/2, yPos, { align: 'center' });
    }

    // PAGINATION sur toutes les pages
    const totalPages = doc.internal.getNumberOfPages();
    for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(156, 163, 175);
        doc.setFont(undefined, 'normal');
        doc.text(`Page ${i} / ${totalPages}`, pageWidth/2, pageHeight - 10, { align: 'center' });
        doc.text('PlayStore Analytics Pro', pageWidth/2, pageHeight - 5, { align: 'center' });
    }

    doc.save(`${data.title || 'app'}_report.pdf`);
}

async function exportPNG() {
    const container = document.getElementById('reportContainer');
    if (!container || !container.innerHTML) {
        toast('Aucun rapport à exporter', 'error');
        return;
    }

    let watermark = null;
    if (!hasLicense) {
        watermark = document.createElement('div');
        watermark.className = 'watermark';
        watermark.textContent = 'VERSION GRATUITE';
        document.body.appendChild(watermark);
    }

    const canvas = await html2canvas(container, {
        scale: 2,
        backgroundColor: '#ffffff',
        logging: false,
        useCORS: true
    });

    if (watermark) {
        watermark.remove();
    }

    canvas.toBlob(blob => {
        downloadFile(blob, `${fullData.title || 'app'}_report.png`);
    });
}

function exportHTML() {
    const data = fullData;
    const container = document.getElementById('reportContainer');

    if (!container || !container.innerHTML) {
        toast('Aucun rapport à exporter', 'error');
        return;
    }

    const styles = Array.from(document.styleSheets)
        .map(sheet => {
            try {
                return Array.from(sheet.cssRules)
                    .map(rule => rule.cssText)
                    .join('\n');
            } catch (e) {
                return '';
            }
        })
        .join('\n');

    const html = `<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${data.title || 'App'} - PlayStore Analytics Report</title>
    <style>
        ${styles}
        body {
            margin: 0;
            padding: 20px;
            background: #fafbfc;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        ${!hasLicense ? `
        .watermark {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 5rem;
            font-weight: 900;
            color: rgba(239, 68, 68, 0.06);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
        }
        ` : ''}
    </style>
</head>
<body>
    ${!hasLicense ? '<div class="watermark">VERSION GRATUITE</div>' : ''}
    <div class="container">
        <div style="text-align:center;margin-bottom:24px;padding:32px;background:#6366f1;color:white;border-radius:8px;">
            <h1 style="margin:0 0 8px 0;font-size:2rem;">PlayStore Analytics Pro</h1>
            <p style="margin:0;font-size:1rem;">Rapport généré le ${new Date().toLocaleDateString('fr-FR')}</p>
        </div>
        ${container.innerHTML}
        <div style="text-align:center;margin-top:32px;padding:16px;color:#6b7280;border-top:1px solid #e5e7eb;">
            <p>Généré par <strong>PlayStore Analytics Pro</strong></p>
        </div>
    </div>
</body>
</html>`;

    const blob = new Blob([html], { type: 'text/html' });
    downloadFile(blob, `${data.title || 'app'}_report.html`);
}

function downloadFile(blob, filename) {
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}

checkLicense();
</script>
</body>
</html>
